# Architecture Diagrams - Cricket Prediction Markets

Visual representations of the system architecture.

## System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                            USER LAYER                                │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐   │
│  │  Desktop   │  │   Mobile   │  │   Tablet   │  │  Mobile    │   │
│  │  Browser   │  │   Browser  │  │   Browser  │  │    App     │   │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘   │
└────────┼───────────────┼───────────────┼───────────────┼───────────┘
         │               │               │               │
         └───────────────┴───────────────┴───────────────┘
                              │
                    ┌─────────▼─────────┐
                    │   Cloudflare CDN   │
                    │   DDoS Protection  │
                    └─────────┬─────────┘
                              │
┌─────────────────────────────▼─────────────────────────────────────┐
│                       FRONTEND LAYER                               │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │              Next.js 14 Application                        │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
│  │  │  Market  │  │   Bet    │  │  Wallet  │  │  User    │  │   │
│  │  │  Browse  │  │   Slip   │  │ Connect  │  │Portfolio │  │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │
│  └───────────────────────────────┬───────────────────────────┘   │
└────────────────────────────────────┼─────────────────────────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              │                      │                      │
        HTTP/REST                WebSocket            TON Connect
              │                      │                      │
┌─────────────▼──────────────────────▼──────────────────────▼───────┐
│                       BACKEND LAYER                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│  │   Market    │  │  Real-Time  │  │    User     │               │
│  │ Management  │◄─┤   Updates   │◄─┤ Management  │               │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘               │
│         │                │                │                        │
│  ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐               │
│  │    Odds     │  │   Cricket   │  │ Settlement  │               │
│  │ Calculation │  │ Data Feed   │  │   Service   │               │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘               │
│         │                │                │                        │
│         └────────────────┼────────────────┘                        │
│                          │                                         │
│  ┌───────────────────────▼────────────────────┐                   │
│  │          PostgreSQL + Redis                │                   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐ │                   │
│  │  │  Markets │  │   Bets   │  │  Users   │ │                   │
│  │  └──────────┘  └──────────┘  └──────────┘ │                   │
│  └────────────────────────────────────────────┘                   │
└─────────────────────────┬──────────────────────────────────────────┘
                          │
                    Event Listeners
                          │
┌─────────────────────────▼──────────────────────────────────────────┐
│                    TON BLOCKCHAIN LAYER                             │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │              Smart Contract Ecosystem                        │  │
│  │                                                               │  │
│  │  ┌────────────────┐         ┌────────────────┐              │  │
│  │  │     Market     │◄────────┤      AMM       │              │  │
│  │  │   Contract     │         │  Pool Contract │              │  │
│  │  └───────┬────────┘         └────────┬───────┘              │  │
│  │          │                           │                       │  │
│  │          │         ┌─────────────────▼──────┐               │  │
│  │          │         │  Jetton Token Contract │               │  │
│  │          │         └─────────────────┬──────┘               │  │
│  │          │                           │                       │  │
│  │  ┌───────▼───────┐         ┌────────▼───────┐               │  │
│  │  │  Settlement   │◄────────┤     Oracle     │               │  │
│  │  │    Manager    │         │    Adapter     │               │  │
│  │  └───────────────┘         └────────────────┘               │  │
│  │                                                               │  │
│  └───────────────────────────────────────────────────────────────┘│
└─────────────────────────┬──────────────────────────────────────────┘
                          │
                    External Data
                          │
┌─────────────────────────▼──────────────────────────────────────────┐
│                    EXTERNAL SERVICES                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  Sportradar  │  │     IPFS     │  │    Payment   │             │
│  │ Cricket API  │  │   Storage    │  │   Gateways   │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
└─────────────────────────────────────────────────────────────────────┘
```

## Smart Contract Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                    Market Contract                           │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  State Variables:                                       │ │
│  │  - admin: slice                                         │ │
│  │  - market_id: int                                       │ │
│  │  - market_type: int (binary/multi/scalar)              │ │
│  │  - market_status: int (pending/active/suspended/settled)││
│  │  - total_liquidity: int                                 │ │
│  │  - outcomes: cell (hashmap)                             │ │
│  │  - resolution_time: int                                 │ │
│  │  - settlement_value: int                                │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Functions:                                             │ │
│  │  - place_bet(outcome_id, amount)                       │ │
│  │  - remove_liquidity()                                   │ │
│  │  - resolve_market(winning_outcome)                     │ │
│  │  - claim_winnings()                                     │ │
│  │  - update_odds()                                        │ │
│  └────────────────────────────────────────────────────────┘ │
└───────────────────┬──────────────────────────────────────────┘
                    │
                    │ Interacts with
                    │
┌───────────────────▼──────────────────────────────────────────┐
│                    AMM Pool Contract                         │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  LMSR Implementation:                                   │ │
│  │                                                          │ │
│  │  Cost Function:                                         │ │
│  │  C(q) = b × ln(Σᵢ e^(qᵢ/b))                           │ │
│  │                                                          │ │
│  │  Price Function:                                        │ │
│  │  P(i) = e^(qᵢ/b) / Σⱼ e^(qⱼ/b)                        │ │
│  │                                                          │ │
│  │  where:                                                 │ │
│  │  - qᵢ = shares of outcome i                            │ │
│  │  - b = liquidity parameter                             │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Functions:                                             │ │
│  │  - calculate_price(outcome_id, quantity)               │ │
│  │  - calculate_cost(outcome_id, shares)                  │ │
│  │  - get_odds(outcome_id)                                │ │
│  └────────────────────────────────────────────────────────┘ │
└───────────────────┬──────────────────────────────────────────┘
                    │
                    │ Uses
                    │
┌───────────────────▼──────────────────────────────────────────┐
│                 Jetton Token Contract                        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  TEP-74 Standard Implementation                         │ │
│  │                                                          │ │
│  │  - Minting (admin only)                                │ │
│  │  - Burning (user or admin)                             │ │
│  │  - Transfer (with restrictions)                        │ │
│  │  - Balance queries                                     │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

## Bet Placement Flow

```
User                Frontend            Backend             Blockchain
  │                     │                   │                     │
  │  1. Browse Market   │                   │                     │
  ├────────────────────►│                   │                     │
  │                     │                   │                     │
  │  2. Select Outcome  │                   │                     │
  ├────────────────────►│                   │                     │
  │                     │                   │                     │
  │  3. Enter Stake     │                   │                     │
  ├────────────────────►│                   │                     │
  │                     │                   │                     │
  │  4. Click "Place"   │                   │                     │
  ├────────────────────►│                   │                     │
  │                     │                   │                     │
  │                     │  5. Get Odds Quote│                     │
  │                     ├──────────────────►│                     │
  │                     │                   │                     │
  │                     │  6. Return Odds   │                     │
  │                     │◄──────────────────┤                     │
  │                     │                   │                     │
  │  7. Confirm in UI   │                   │                     │
  │◄────────────────────┤                   │                     │
  │                     │                   │                     │
  │  8. Open Wallet     │                   │                     │
  ├────────────────────►│                   │                     │
  │                     │                   │                     │
  │                     │  9. Construct TX  │                     │
  │                     ├───────────────────┼────────────────────►│
  │                     │                   │                     │
  │  10. Sign TX        │                   │   11. Validate      │
  ├────────────────────►│                   │       & Process     │
  │                     │                   │                     │
  │                     │                   │   12. Update State  │
  │                     │                   │◄────────────────────┤
  │                     │                   │                     │
  │                     │  13. Emit Event   │                     │
  │                     │◄──────────────────┤◄────────────────────┤
  │                     │                   │                     │
  │                     │  14. Update DB    │                     │
  │                     │◄──────────────────┤                     │
  │                     │                   │                     │
  │                     │  15. Recalc Odds  │                     │
  │                     │◄──────────────────┤                     │
  │                     │                   │                     │
  │  16. Show Success   │                   │                     │
  │◄────────────────────┤                   │                     │
  │                     │                   │                     │
  │  17. Update UI      │                   │                     │
  │◄────────────────────┤                   │                     │
  │                     │                   │                     │
```

## Settlement Flow

```
Real World          Data Feed           Oracle            Smart Contract
    │                   │                   │                     │
    │  1. Match Ends    │                   │                     │
    ├──────────────────►│                   │                     │
    │                   │                   │                     │
    │                   │  2. Fetch Result  │                     │
    │                   ├──────────────────►│                     │
    │                   │   (Multiple       │                     │
    │                   │    Sources)       │                     │
    │                   │                   │                     │
    │                   │  3. Aggregate     │                     │
    │                   │     Results       │                     │
    │                   │                   │                     │
    │                   │  4. Validate      │                     │
    │                   │     Consensus     │                     │
    │                   │     (3-of-5)      │                     │
    │                   │                   │                     │
    │                   │                   │  5. Sign Result     │
    │                   │                   ├────────────────────►│
    │                   │                   │                     │
    │                   │                   │  6. Verify Oracle   │
    │                   │                   │     Authority       │
    │                   │                   │                     │
    │                   │                   │  7. Update Market   │
    │                   │                   │     Status:SETTLED  │
    │                   │                   │                     │
    │                   │                   │  8. Calculate       │
    │                   │                   │     Payouts         │
    │                   │                   │                     │
    │                   │  9. Emit Event    │                     │
    │                   │◄──────────────────┼─────────────────────┤
    │                   │                   │                     │
    │                   │  10. Notify Users │                     │
    │◄──────────────────┤◄──────────────────┤                     │
    │                   │                   │                     │
    │                   │                   │  11. Users Claim    │
    │───────────────────┼───────────────────┼────────────────────►│
    │                   │                   │                     │
    │                   │                   │  12. Transfer TON   │
    │◄──────────────────┼───────────────────┼─────────────────────┤
    │                   │                   │                     │
```

## Odds Calculation Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                   Odds Calculation Engine                    │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              LMSR Calculator (Python)                   │ │
│  │                                                          │ │
│  │  Input: Current shares [q₁, q₂, ..., qₙ]              │ │
│  │         Liquidity parameter b                           │ │
│  │         New bet (outcome_id, amount)                   │ │
│  │                                                          │ │
│  │  Step 1: Calculate current probabilities               │ │
│  │  ┌──────────────────────────────────────┐              │ │
│  │  │ exp_terms = e^(qᵢ/b) for each i     │              │ │
│  │  │ sum = Σ exp_terms                    │              │ │
│  │  │ P(i) = exp_terms[i] / sum            │              │ │
│  │  └──────────────────────────────────────┘              │ │
│  │                                                          │ │
│  │  Step 2: Calculate cost of new bet                     │ │
│  │  ┌──────────────────────────────────────┐              │ │
│  │  │ C_before = b × ln(Σ e^(qᵢ/b))       │              │ │
│  │  │ qₖ' = qₖ + amount                    │              │ │
│  │  │ C_after = b × ln(Σ e^(qᵢ'/b))       │              │ │
│  │  │ cost = C_after - C_before            │              │ │
│  │  └──────────────────────────────────────┘              │ │
│  │                                                          │ │
│  │  Step 3: Update shares and recalculate odds            │ │
│  │  ┌──────────────────────────────────────┐              │ │
│  │  │ qₖ = qₖ + amount                     │              │ │
│  │  │ P'(i) = e^(qᵢ/b) / Σ e^(qⱼ/b)       │              │ │
│  │  │ odds(i) = 1 / P'(i)                  │              │ │
│  │  └──────────────────────────────────────┘              │ │
│  │                                                          │ │
│  │  Step 4: Apply platform fee                            │ │
│  │  ┌──────────────────────────────────────┐              │ │
│  │  │ adjusted_P(i) = P(i) × (1 + fee)     │              │ │
│  │  │ display_odds(i) = 1 / adjusted_P(i)  │              │ │
│  │  └──────────────────────────────────────┘              │ │
│  │                                                          │ │
│  │  Output: Updated odds for all outcomes                 │ │
│  │         Cost of bet in base currency                   │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                   Caching Layer                         │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │ │
│  │  │   L1 Cache   │  │   L2 Cache   │  │  TimescaleDB │ │ │
│  │  │  (In-Memory) │  │   (Redis)    │  │  (Historical)│ │ │
│  │  │   60 sec     │  │   300 sec    │  │   Permanent  │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘ │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

## Database Schema

```
┌─────────────────────────────────────────────────────────────┐
│                      PostgreSQL Tables                       │
└─────────────────────────────────────────────────────────────┘

┌───────────────────────┐      ┌───────────────────────┐
│       markets         │      │        matches        │
├───────────────────────┤      ├───────────────────────┤
│ id (PK)               │◄─┐   │ id (PK)               │
│ contract_address      │  │   │ tournament_id         │
│ market_type           │  │   │ team1_id              │
│ match_id (FK)         │──┘   │ team2_id              │
│ tournament_id (FK)    │      │ venue                 │
│ title                 │      │ start_time            │
│ description           │      │ status                │
│ outcomes (JSONB)      │      │ result (JSONB)        │
│ status                │      └───────────────────────┘
│ total_volume          │
│ liquidity_parameter   │      ┌───────────────────────┐
│ created_at            │      │        teams          │
│ updated_at            │      ├───────────────────────┤
└───────────┬───────────┘      │ id (PK)               │
            │                  │ name                  │
            │                  │ code                  │
            │                  │ flag_url              │
            │                  │ ranking               │
            │                  └───────────────────────┘
            │
            │  1:N
            │
┌───────────▼──────────────────────────────────────────────────┐
│                          bets                                 │
│  (Partitioned by placed_at timestamp)                        │
├──────────────────────────────────────────────────────────────┤
│ id (PK)                                                       │
│ user_id                                                       │
│ market_id (FK)                                                │
│ outcome_id                                                    │
│ amount                                                        │
│ odds                                                          │
│ status (pending/confirmed/settled/cancelled)                 │
│ placed_at                                                     │
│ settled_at                                                    │
│ payout                                                        │
│ transaction_hash                                              │
└───────────────────────────────────────────────────────────────┘

Partitions:
├── bets_2026_02 (Feb 2026)
├── bets_2026_03 (Mar 2026)
└── bets_2026_04 (Apr 2026)

Indexes:
├── idx_bets_user (user_id, placed_at DESC)
├── idx_bets_market (market_id, status)
└── idx_bets_transaction (transaction_hash)
```

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Production Stack                        │
└─────────────────────────────────────────────────────────────┘

                        ┌─────────────┐
                        │  Cloudflare │
                        │     CDN     │
                        └──────┬──────┘
                               │
                    ┌──────────▼──────────┐
                    │   NGINX Load        │
                    │   Balancer          │
                    └──────────┬──────────┘
                               │
              ┌────────────────┼────────────────┐
              │                │                │
      ┌───────▼───────┐┌───────▼───────┐┌──────▼───────┐
      │   Next.js     ││   Next.js     ││   Next.js    │
      │   Server 1    ││   Server 2    ││   Server 3   │
      └───────┬───────┘└───────┬───────┘└──────┬───────┘
              │                │                │
              └────────────────┼────────────────┘
                               │
      ┌────────────────────────┼────────────────────────┐
      │                        │                        │
┌─────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
│   Market   │ │    Odds     │ │  Real-Time  │ │    User     │
│  Service   │ │   Engine    │ │   Updates   │ │  Service    │
└─────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
      │                │                │                │
      └────────────────┼────────────────┼────────────────┘
                       │                │
      ┌────────────────▼────────────────▼────────────────┐
      │          PostgreSQL Primary + Replicas            │
      │  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
      │  │ Primary  │──┤ Replica  │  │ Replica  │       │
      │  │  (RW)    │  │  (RO)    │  │  (RO)    │       │
      │  └──────────┘  └──────────┘  └──────────┘       │
      └───────────────────────────────────────────────────┘

      ┌───────────────────────────────────────────────────┐
      │           Redis Cluster (6 nodes)                  │
      │  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  │
      │  │ M1 │──│ S1 │  │ M2 │──│ S2 │  │ M3 │──│ S3 │  │
      │  └────┘  └────┘  └────┘  └────┘  └────┘  └────┘  │
      └───────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   Monitoring Stack                           │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │Prometheus│  │ Grafana  │  │  Sentry  │  │ Datadog  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Security Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                     Security Layers                           │
└──────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Layer 1: Network Security                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ - Cloudflare DDoS Protection                            │ │
│  │ - Web Application Firewall (WAF)                       │ │
│  │ - Rate Limiting (per IP, per user)                     │ │
│  │ - GeoIP Filtering (compliance)                         │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Layer 2: Application Security                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ - JWT Authentication                                    │ │
│  │ - Role-Based Access Control (RBAC)                     │ │
│  │ - Input Validation (Zod schemas)                       │ │
│  │ - SQL Injection Prevention (parameterized queries)     │ │
│  │ - XSS Protection (Content Security Policy)             │ │
│  │ - CSRF Tokens                                          │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Layer 3: Smart Contract Security                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ - Reentrancy Guards                                    │ │
│  │ - Integer Overflow Protection                          │ │
│  │ - Access Control Modifiers                             │ │
│  │ - Emergency Pause Mechanism                            │ │
│  │ - Timelock for Admin Actions                           │ │
│  │ - Multi-signature for Critical Operations              │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Layer 4: Data Security                                      │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ - Encryption at Rest (AES-256)                         │ │
│  │ - Encryption in Transit (TLS 1.3)                      │ │
│  │ - Database Connection Encryption                       │ │
│  │ - PII Data Masking                                     │ │
│  │ - Secure Key Management (HSM)                          │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Layer 5: Monitoring & Compliance                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ - Audit Logging (immutable)                            │ │
│  │ - Anomaly Detection (ML-based)                         │ │
│  │ - KYC/AML Screening                                    │ │
│  │ - Transaction Monitoring                               │ │
│  │ - Incident Response Plan                               │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

These diagrams provide visual representation of the system architecture. For detailed technical specifications, see `/docs/architecture.md`.
